---
title:  数据库的锁机制
date:   2016-09-28 20:30:52
---
数据库管理系统中的并发控制的任务是--确保在多个事务同时存取数据库中同一数据时不破坏事务的隔离性和统一性以及数据库的统一性。在计算机科学，特别是程序设计、操作系统、多处理机和数据库等领域，并发控制（Concurrency control）是确保并及时纠正由并发操作导致的错误的一种机制。

在并发访问情况下，可能会出现脏读、不可重复读和幻读等读现象，为了应对这些问题，主流数据库都提供了锁机制，并引入了事务隔离级别的概念。

**锁**--当并发事务访问同一资源时，有可能导致数据不一致，因此需要一种机制来将数据访问顺序化，以保证数据库数据的一致性。锁就是其中的一种机制，在执行多线程时用于强行限制资源访问的同步机制，即用于在并发控制中保证对互斥要求的满足。

MySQL InnoDB默认行级锁。行级锁都是基于索引的，如果一条SQL语句用不到索引是不会使用行级锁的，会使用表级锁把整张表锁住。

#### 锁的分类

按操作划分--DML锁、DDL锁

按锁的粒度划分--表级锁、行级锁、页级锁（mysql）

按锁级别划分--共享锁、排它锁

按加锁方式划分--自动锁、显示锁

按使用方式划分--乐观锁、悲观锁

DML锁（data locks, 数据锁）--用于保护数据的完整性，其中包括行级锁、表级锁

DDL锁（dictionary locks, 数据字典锁）--用于保护数据库对象的结构，如表、索引等的结构定义，其中包括排它DDL锁、共享DDL锁、可中断解析锁

#### 乐观锁和悲观锁

乐观并发控制（乐观锁）和悲观并发控制（悲观锁）就是并发控制主要采用的技术手段。乐观锁和悲观锁是人们定义出来的概念，可以认为是一种思想，其实不仅是关系型数据库系统中有这些概念，像memcache、hibernate等都有类似概念；更不要把他们和数据中提供的提供的锁机制（行锁、表锁、排它锁、共享锁）混为一谈。

**悲观锁**--指的是对数据被外界修改持保守态度，在整个数据处理过程中，将数据处于锁定状态。

在关系数据库管理系统中，悲观锁的实现依靠数据库提供的锁机制（也只有数据库层提供的锁机制才能正真保证数据访问的排他性），**数据库中悲观锁的流程**如下：

。。在对任意记录进行操作之前，先尝试为该记录加上排它锁（exclusive locking）

。。如果加锁失败，说明该记录正在被修改，那么当前查询可能要等待或者抛出异常，具体响应方式由开发者根据实际需要决定

。。如果加锁成功，就可以对其做相应操作，直到事务完成之后就会解锁了

。。这期间如果有其他事务尝试对该记录做修改或是排它锁的操作，都会等待我们解锁或直接抛出异常

**优点与不足**--悲观并发控制实际上是“先取锁再访问”的保守策略，为数据处理的安全提供了保证，但是在效率方面加锁机制会让数据库产生额外的开销，还有增加死锁的机会；也会降低并行性，一个事务如果锁定了某行数据，其他事务就必须等待该事务处理完才可以。

**乐观锁**--相对悲观锁而言，它假设认为数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则让返回用户错误的信息。

相对于悲观锁，在对数据库进行处理的时候，乐观锁并不会使用数据库提供的锁机制，一般实现乐观锁的方式就是记录数据版本（为数据增加的一个版本标识（使用版本号或是时间戳），读取数据时将版本标识的值一同读出，数据每更新一次，同时对版本标识进行更新），提交时对比版本信息进行校验。

**优点与不足**--乐观并发控制相信事务之间的数据竞争的概率是很小的，，但如果直接简单这么做，还是有可能会遇到不可预期的结果，例如两个事务都读取了数据库的某一行，经过修改以后写回数据库，这时就遇到了问题。