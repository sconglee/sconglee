---
title: Hibernate ORM
date: 2016-11-10 22:50:52
math: y
---
一个轻量级的ORM框架，主要不仅负责从Java类到数据库表的映射（还包括从Java数据类型到SQL数据类型的映射），还提供了面向对象的数据查询检索机制，从而极大地缩短的手动处理SQL和JDBC上的开发时间。

#### ORM基本对应规则
- 类跟表相对应
- 类的属性跟表的字段相对应
- 类的实例与表中具体的一条记录相对应
- 一个类可以对应多个表，一个表也可以对应多个类
- DB中的表可以没有主键，但是类中必须设置主键字段
- DB中表与表之间的关系映射成为类之间的关系
- object中属性的个数和名称可以和表中定义的字段个数和名称不一样

#### SessionFactory
负责初始化hibernate，可以被看作是数据源的代理，可以用来创建session对象。SessionFactory是线程安全的，因此可以被多个线程同时访问。SessionFactory在hibernate启动时创建一次（应该使用单例模式来实现）。

#### Session
hibernate中的session不是！不是！绝不是！http中所说的session，它是一个轻量级的非线程安全的对象，用来表示应用程序和数据库的一次交互（会话），主要负责被持久化对象和数据库的操作，包含一般的持久化方法CRUD。可以使用SessionFactory创建一个session，当对数据库的所有操作都执行完成后，就可以关闭session，session在访问数据库时才会建立与DB的连接，所以说此对象生存期很短且隐藏了JDBC链接，也是Transaction的工厂。

#### 二级缓存
一级缓存由session来管理，二级缓存由SessionFactory来管理，在使用时，二级缓存是可有可无的，但一级缓存是必须的。

一级缓存使用的场景：当使用session查询数据时，首先会在session内部查找该对象，若存在，则直接返回，否则就到数据库去查询，并将结果缓存起来以便以后使用。一级缓存的缺点就是当使用session表示一次会话时，它的生命周期较短，而且它是线程不安全的，不能被多个线程所共享，因此对效率的提升不是非常明显。

二级缓存概念：二级缓存用来配置一种全局的缓存，以便实现多个线程与事务共享。在使用了二级缓存机制后，当查询数据时，首先会到内部缓存中查询，如果没有再到二级缓存中查找，最后才去数据库中查找。与一级缓存相比，二级缓存是独立于hibernate软件部分，属于第三方的产品，常见的有Ehcache，OScache等，hibernate提供了CacheProvider接口来充当缓存插件与hibernate之间的适配器。二级缓存除了可以把内存当作存储介质外，还可以选用硬盘等外部存储设备。

二级缓存适用场景：
- 数据量较小，如果数据量太大，缓存太多，会消耗大量内存，造成内存资源短缺，从而降低系统的性能
- 对数据的修改较少，如果进行大量的修改，就需要频繁的对缓存中的数据和数据库中的数据进行同步，这也会影响系统的性能
- 不会被大量的应用共享的数据，如果数据被大量线程或事务共享，多线程访问时的同步机制也会影响系统的性能
- 不是很重要的数据，如果查询的数据很重要（比如财务数据），对数据的正确性要求很高，最好不要使用二级缓存

#### How 提升性能？
- 延迟加载（当获取一个对象的集合属性值或获取一个对象所关联的另一个对象时）
- 缓存技术（合理配置缓存的参数，例如配置缓存可以加载数据的个数）
- 优化查询语句